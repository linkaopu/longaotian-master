<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>密封圈质量检测系统</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        danger: '#F53F3F',
                        warning: '#FF7D00',
                        dark: '#1D2129',
                        'gray-light': '#F2F3F5',
                        'gray-medium': '#C9CDD4'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .shadow-soft {
        box-shadow: 0 2px 14px 0 rgba(0, 0, 0, 0.06);
      }
      .transition-smooth {
        transition: all 0.3s ease;
      }
      

      
      /* 卡片悬停效果 */
      .card-hover {
        transition: all 0.3s ease;
      }
      
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-soft sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-cogs text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">O型圈质量检测系统</h1>
            </div>

            <nav class="hidden md:flex items-center space-x-6">
                <a href="#"
                    class="text-primary font-medium border-b-2 border-primary px-3 py-2 rounded-lg bg-primary/10">首页</a>
                <a href="history.html"
                    class="text-gray-600 hover:text-primary hover:bg-gray-100 transition-smooth px-3 py-2 rounded-lg">历史记录</a>
                <a href="statistics.html"
                    class="text-gray-600 hover:text-primary hover:bg-gray-100 transition-smooth px-3 py-2 rounded-lg">检测统计</a>
            </nav>

            <div class="flex items-center space-x-4">
                <!-- 用户信息显示区域 -->
                <div id="user-info" class="hidden">
                    <span class="text-gray-700 mr-3">
                        <i class="fa fa-user-circle mr-1"></i>
                        <span id="username-display"></span>
                    </span>
                    <button id="logout-btn"
                        class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg transition-smooth">
                        <i class="fa fa-sign-out mr-1"></i>退出登录
                    </button>
                </div>

                <!-- 登录链接 -->
                <div id="login-link">
                    <a href="log.html?return=/"
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-smooth">
                        <i class="fa fa-sign-in mr-1"></i>登录
                    </a>
                </div>

                <button class="md:hidden text-gray-600 text-xl">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-6">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div
                class="bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-2xl shadow-lg p-6 flex items-center transform hover:scale-105 transition-all duration-300">
                <div
                    class="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-400 to-indigo-600 flex items-center justify-center text-white mr-5 shadow-lg">
                    <i class="fa fa-cogs text-2xl"></i>
                </div>
                <div>
                    <p class="text-indigo-600 text-sm font-medium mb-1">总检测数量</p>
                    <p class="text-3xl font-bold text-indigo-800" id="total-count">0</p>
                </div>
            </div>

            <div
                class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-2xl shadow-lg p-6 flex items-center transform hover:scale-105 transition-all duration-300">
                <div
                    class="w-16 h-16 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white mr-5 shadow-lg">
                    <i class="fa fa-check-circle text-2xl"></i>
                </div>
                <div>
                    <p class="text-green-600 text-sm font-medium mb-1">通过数量</p>
                    <p class="text-3xl font-bold text-green-800" id="passed-count">0</p>
                </div>
            </div>

            <div
                class="bg-gradient-to-br from-red-50 to-red-100 border border-red-200 rounded-2xl shadow-lg p-6 flex items-center transform hover:scale-105 transition-all duration-300">
                <div
                    class="w-16 h-16 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white mr-5 shadow-lg">
                    <i class="fa fa-times-circle text-2xl"></i>
                </div>
                <div>
                    <p class="text-red-600 text-sm font-medium mb-1">失败数量</p>
                    <p class="text-3xl font-bold text-red-800" id="failed-count">0</p>
                </div>
            </div>

            <div
                class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl shadow-lg p-6 flex items-center transform hover:scale-105 transition-all duration-300">
                <div
                    class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white mr-5 shadow-lg">
                    <i class="fa fa-clock-o text-2xl"></i>
                </div>
                <div>
                    <p class="text-blue-600 text-sm font-medium mb-1">平均处理时间</p>
                    <p class="text-3xl font-bold text-blue-800" id="avg-time">0.00s</p>
                </div>
            </div>
        </div>

        <!-- 主要工作区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：上传与设置 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 密封圈图片上传区域 -->
                <div class="bg-white rounded-xl shadow-soft p-5 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-upload text-primary mr-2"></i>密封圈图片上传
                    </h2>

                    <div class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-primary hover:bg-primary/5 transition-all duration-300 cursor-pointer group"
                        id="oring-upload-area">
                        <div
                            class="w-20 h-20 rounded-full bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
                            <i class="fa fa-cloud-upload text-3xl text-primary"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">拖放图像到此处或点击上传</h3>
                        <p class="text-gray-500 mb-4">支持 PNG、JPG 格式，单张不超过10MB</p>
                        <input type="file" id="oring-image-upload" accept="image/png, image/jpeg" class="hidden"
                            multiple>
                        <button
                            class="bg-gradient-to-r from-primary to-primary/80 text-white px-6 py-3 rounded-xl hover:from-primary/90 hover:to-primary/70 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <i class="fa fa-folder-open mr-2"></i>选择图像
                        </button>
                    </div>

                    <div class="mt-4" id="oring-uploaded-files">
                        <!-- 上传的文件列表将在这里显示 -->
                    </div>
                </div>

                <!-- 处理按钮 -->
                <div class="bg-white rounded-xl shadow-soft p-5 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-play text-primary mr-2"></i>开始检测
                    </h2>

                    <div class="text-center">
                        <p class="text-gray-600 mb-6">上传图像后点击下方按钮开始O型圈质量检测</p>
                        <button id="process-btn"
                            class="w-full bg-gradient-to-r from-primary to-primary/80 text-white py-4 rounded-xl hover:from-primary/90 hover:to-primary/70 transition-all duration-300 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <i class="fa fa-play mr-2"></i> 开始处理
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：结果展示 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 图像对比展示 -->
                <div class="bg-white rounded-xl shadow-soft p-5 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-images text-primary mr-2"></i>图像处理结果
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- 原始图像 -->
                        <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
                            <div class="flex items-center justify-center mb-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                <p class="text-sm font-medium text-gray-700">原始图像</p>
                            </div>
                            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl flex items-center justify-center min-h-[250px] border-2 border-dashed border-gray-200"
                                id="original-image-container">
                                <img id="original-image" src="" alt="原始图像"
                                    class="max-w-full max-h-[250px] hidden rounded-lg">
                                <div class="text-center" id="original-placeholder">
                                    <i class="fa fa-image text-4xl text-gray-300 mb-2"></i>
                                    <p class="text-gray-400 text-sm">请上传图像</p>
                                </div>
                            </div>
                        </div>

                        <!-- 处理后图像 -->
                        <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
                            <div class="flex items-center justify-center mb-3">
                                <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                <p class="text-sm font-medium text-gray-700">处理后图像</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl flex items-center justify-center min-h-[250px] border-2 border-dashed border-blue-200"
                                id="processed-image-container">
                                <img id="processed-image" src="" alt="处理后图像"
                                    class="max-w-full max-h-[250px] hidden rounded-lg">
                                <div class="text-center" id="processed-placeholder">
                                    <i class="fa fa-cogs text-4xl text-blue-300 mb-2 animate-spin"></i>
                                    <p class="text-blue-400 text-sm">等待处理...</p>
                                </div>
                            </div>
                        </div>

                        <!-- 带圆轮廓的原图 -->
                        <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
                            <div class="flex items-center justify-center mb-3">
                                <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                                <p class="text-sm font-medium text-gray-700">检测结果图像</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl flex items-center justify-center min-h-[250px] border-2 border-dashed border-purple-200"
                                id="original-with-circles-container">
                                <img id="original-with-circles-image" src="" alt="检测结果图像"
                                    class="max-w-full max-h-[250px] hidden rounded-lg">
                                <div class="text-center" id="original-with-circles-placeholder">
                                    <i class="fa fa-search text-4xl text-purple-300 mb-2"></i>
                                    <p class="text-purple-400 text-sm">等待处理...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分析结果 -->
                <div class="bg-white rounded-xl shadow-soft p-5 card-hover">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-bar-chart text-primary mr-2"></i>分析结果
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 直方图 -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                            <div class="flex items-center mb-4">
                                <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                                <p class="text-sm font-medium text-gray-700">像素直方图</p>
                            </div>
                            <div
                                class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 h-[200px] border border-orange-200">
                                <canvas id="histogram-chart"></canvas>
                            </div>
                        </div>

                        <!-- 检测结果 -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                            <div class="flex items-center mb-4">
                                <div class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></div>
                                <p class="text-sm font-medium text-gray-700">检测详情</p>
                            </div>
                            <div
                                class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-6 h-[200px] flex flex-col justify-center border border-indigo-200">
                                <div class="text-center mb-4">
                                    <span id="detection-result"
                                        class="inline-block px-6 py-3 rounded-full text-white font-semibold bg-gray-400 shadow-lg">
                                        等待检测
                                    </span>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div class="flex justify-between items-center bg-white/50 rounded-lg px-3 py-2">
                                        <span class="text-gray-600 font-medium">质心坐标:</span>
                                        <span id="centroid-coords" class="text-gray-800 font-mono">-,-</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-white/50 rounded-lg px-3 py-2">
                                        <span class="text-gray-600 font-medium">内半径:</span>
                                        <span id="inner-radius" class="text-gray-800 font-mono">- px</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-white/50 rounded-lg px-3 py-2">
                                        <span class="text-gray-600 font-medium">外半径:</span>
                                        <span id="outer-radius" class="text-gray-800 font-mono">- px</span>
                                    </div>
                                    <div class="flex justify-between items-center bg-white/50 rounded-lg px-3 py-2">
                                        <span class="text-gray-600 font-medium">处理时间:</span>
                                        <span id="process-time" class="text-gray-800 font-mono">- s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近处理记录 -->
                <div class="bg-white rounded-xl shadow-soft p-5 card-hover">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-history text-primary mr-2"></i>最近处理记录
                        </h2>
                        <a href="#" class="text-primary text-sm hover:underline">查看全部</a>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th
                                        class="py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                                        <i class="fa fa-image mr-2 text-primary"></i>图像名称
                                    </th>
                                    <th
                                        class="py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                                        <i class="fa fa-check-circle mr-2 text-primary"></i>结果
                                    </th>
                                    <th
                                        class="py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                                        <i class="fa fa-clock-o mr-2 text-primary"></i>时间
                                    </th>
                                    <th
                                        class="py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                                        <i class="fa fa-cogs mr-2 text-primary"></i>操作
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="history-records" class="divide-y divide-gray-100">
                                <!-- 记录将通过JavaScript动态添加 -->
                                <tr class="hover:bg-gray-50 transition-colors duration-200">
                                    <td colspan="4" class="py-8 text-center">
                                        <div class="text-gray-400">
                                            <i class="fa fa-inbox text-4xl mb-2"></i>
                                            <p class="text-sm">暂无记录</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gradient-to-r from-gray-50 to-gray-100 border-t border-gray-200 mt-12">
        <div class="container mx-auto px-4 py-8">
            <div class="text-center">
                <div class="flex items-center justify-center mb-4">
                    <i class="fa fa-cogs text-primary text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">O型圈质量检测系统</h3>
                </div>
                <div class="text-gray-500 text-sm space-y-1">
                    <p>© 2024 O型圈质量检测系统 - 版权所有</p>
                    <p>版本 1.0.0 | 基于计算机视觉的智能检测</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // 初始化直方图图表
        const ctx = document.getElementById('histogram-chart').getContext('2d');
        const histogramChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: 256 }, (_, i) => i),
                datasets: [{
                    label: '像素分布',
                    data: Array(256).fill(0),
                    borderColor: '#165DFF',
                    backgroundColor: 'rgba(22, 93, 255, 0.1)',
                    borderWidth: 1,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        display: false
                    },
                    y: {
                        display: false
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 将直方图图表对象暴露到window全局对象
        window.histogramChart = histogramChart;

        // 检查用户登录状态
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/check_login', {
                    credentials: 'include'
                });
                const data = await response.json();

                const operatorButton = document.querySelector('button.bg-gray-light');

                if (data.logged_in) {
                    // 用户已登录，显示用户名
                    operatorButton.innerHTML = `<i class="fa fa-user-circle mr-1"></i> ${data.user.username}`;
                } else {
                    // 用户未登录，保持原有显示
                    operatorButton.innerHTML = '<i class="fa fa-user-circle mr-1"></i> 操作员';
                }
            } catch (error) {
                console.error('检查登录状态时出错:', error);
            }
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();

            // 为操作员按钮添加点击事件
            const operatorButton = document.querySelector('button.bg-gray-light');
            operatorButton.addEventListener('click', function () {
                // 检查登录状态并跳转
                fetch('/api/check_login', {
                    credentials: 'include'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.logged_in) {
                            // 用户已登录，可以执行其他操作或者跳转到用户中心
                            alert(`欢迎，${data.user.username}!`);
                        } else {
                            // 用户未登录，跳转到登录页面
                            window.location.href = '/login';
                        }
                    })
                    .catch(error => {
                        console.error('检查登录状态时出错:', error);
                        // 出错时也跳转到登录页面
                        window.location.href = '/login';
                    });
            });
        });
    </script>
    <script src="detection.js"></script>
</body>

</html>